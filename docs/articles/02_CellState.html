<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Coralysis">
<title>Cell state identification â€¢ Coralysis</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cell state identification">
<meta property="og:description" content="Coralysis">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">Coralysis</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/01_QuickStart.html">Integration &amp; reference-mapping</a>
    <a class="dropdown-item" href="../articles/02_CellState.html">Cell state identification</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/elolab/Coralysis/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Cell state identification</h1>
            
            <h4 data-toc-skip class="date">16.01.2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/elolab/Coralysis/blob/HEAD/vignettes/02_CellState.Rmd" class="external-link"><code>vignettes/02_CellState.Rmd</code></a></small>
      <div class="d-none name"><code>02_CellState.Rmd</code></div>
    </div>

    
    
<p><br></p>
<p><br></p>
<hr>
<p><br></p>
<p><br></p>
<div class="section level2">
<h2 id="integration">Integration<a class="anchor" aria-label="anchor" href="#integration"></a>
</h2>
<p><br></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Packages loaded</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"SingleCellExperiment"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="http://bioconductor.org/packages/scater/" class="external-link">"scater"</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://dplyr.tidyverse.org" class="external-link">"dplyr"</a></span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/elolab/Coralysis" class="external-link">"Coralysis"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Packages not loaded, but required:</span></span>
<span><span class="co">#library("scran") </span></span>
<span><span class="co">#library("cowplot")</span></span>
<span><span class="co">#library("ComplexHeatmap")</span></span></code></pre></div>
<p>The single-cell RNA sequencing dataset of peripheral blood
mononuclear cells (PBMCs) from healthy versus COVID-19 infected donors
published by <a href="https://www.nature.com/articles/s41591-020-0944-y" class="external-link">Wilk et al.,
(2020)</a> will be used to demonstrated how cell cluster probability can
be used to identify cell states and associated differential gene
expression programs.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Import data </span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"covid_Wilk_et_al.rds"</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
<p><br></p>
<hr>
<p><br></p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="normalization">Normalization<a class="anchor" aria-label="anchor" href="#normalization"></a>
</h2>
<p><br></p>
<p><code>Coralysis</code> requires log-normalised data as input. The
dataset above has been previously normalised with the basic
log-normalisation method in <code>Seurat</code>. Below is a simple
custom function that can be used to perform <code>Seurat</code> (see <a href="https://satijalab.org/seurat/reference/normalizedata" class="external-link">NormalizeData</a>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Normalize the data</span></span>
<span><span class="co"># log1p normalization</span></span>
<span><span class="va">SeuratNormalisation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># 'SeuratNormalisation()' function applies the basic Seurat normalization to</span></span>
<span>  <span class="co">#a SingleCellExperiment object with a 'counts' assay. Normalized data</span></span>
<span>  <span class="co">#is saved in the 'logcounts' assay.</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/dge.html" class="external-link">counts</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log1p</a></span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">*</span><span class="fl">10000</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span> <span class="co"># log1p normalization w/ 10K scaling factor</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">as</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/assays.html" class="external-link">logcounts</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span>, <span class="st">"sparseMatrix"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu">SeuratNormalisation</span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span><span class="op">)</span></span></code></pre></div>
<p>In alternative, <code>scran</code> normalization can be performed,
which is particularly beneficial if rare cell types exist (see the
following <a href="https://bioconductor.org/packages/devel/bioc/vignettes/scran/inst/doc/scran.html" class="external-link">vignette</a>).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## scran normalisation</span></span>
<span><span class="va">ScranNormalisation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">norm_clusters</span> <span class="op">&lt;-</span> <span class="fu">scran</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scran/man/quickCluster.html" class="external-link">quickCluster</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span>    <span class="va">object</span> <span class="op">&lt;-</span> <span class="fu">scran</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scran/man/computeSumFactors.html" class="external-link">computeSumFactors</a></span><span class="op">(</span><span class="va">object</span>, clusters <span class="op">=</span> <span class="va">norm_clusters</span><span class="op">)</span></span>
<span>    <span class="va">object</span> <span class="op">&lt;-</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scuttle/man/logNormCounts.html" class="external-link">logNormCounts</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">object</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Split object by batch: 'Donor_full'</span></span>
<span><span class="va">batch.levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">sce</span><span class="op">$</span><span class="va">Donor_full</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">batch.levels</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">batch.levels</span></span>
<span><span class="va">sce.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">batch.levels</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">sce</span><span class="op">[</span>,<span class="va">sce</span><span class="op">$</span><span class="va">Donor_full</span> <span class="op">==</span> <span class="va">x</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply normalisation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sce.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">sce.list</span>, <span class="va">ScranNormalisation</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Join </span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>, <span class="va">sce.list</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
<p><br></p>
<hr>
<p><br></p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="hvg-selection">HVG selection<a class="anchor" aria-label="anchor" href="#hvg-selection"></a>
</h2>
<p><br></p>
<p>Highly variable genes (HVG) can be selected using the R package
<code>scran</code>. The variable <code>Donor_full</code> from
<code>colData</code> is used as batch label. The
<code>SingleCellExperiment</code> object can comprise alternative
experiments. The main experiment was called <code>raw</code> and, the
alternative with HVG, <code>hvg</code>. This is important to keep a
backup of all genes in the same <code>SingleCellExperiment</code> object
before selecting HVGs (see <a href="https://www.bioconductor.org/packages/devel/bioc/vignettes/SingleCellExperiment/inst/doc/intro.html" class="external-link">SingleCellExperiment
vignette</a>).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Feature selection with 'scran' package</span></span>
<span><span class="va">nhvg</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span><span class="va">batch.label</span> <span class="op">&lt;-</span> <span class="st">"Donor_full"</span></span>
<span><span class="va">sce</span><span class="op">[[</span><span class="va">batch.label</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">sce</span><span class="op">[[</span><span class="va">batch.label</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">m.hvg</span> <span class="op">&lt;-</span> <span class="fu">scran</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scran/man/modelGeneVar.html" class="external-link">modelGeneVar</a></span><span class="op">(</span><span class="va">sce</span>, block<span class="op">=</span><span class="va">sce</span><span class="op">[[</span><span class="va">batch.label</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">hvg.ordered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">m.hvg</span><span class="op">[[</span><span class="st">"bio"</span><span class="op">]</span><span class="op">]</span>, decreasing<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">top.hvg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span><span class="op">[</span><span class="va">hvg.ordered</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">nhvg</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SummarizedExperiment/man/SummarizedExperiment-class.html" class="external-link">rowData</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="st">"highly_variable"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/row.names.html" class="external-link">row.names</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">top.hvg</span>, <span class="va">m.hvg</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Name main expression assay &amp; swap assays</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/altExps.html" class="external-link">mainExpName</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"raw"</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/altExps.html" class="external-link">altExp</a></span><span class="op">(</span><span class="va">sce</span>, <span class="st">"hvg"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sce</span><span class="op">[</span><span class="va">top.hvg</span>,<span class="op">]</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/swapAltExp.html" class="external-link">swapAltExp</a></span><span class="op">(</span><span class="va">sce</span>, <span class="st">"hvg"</span>, withColData <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><br></p>
<p><br></p>
<hr>
<p><br></p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="dimred---before-integration">Dimred - before integration<a class="anchor" aria-label="anchor" href="#dimred---before-integration"></a>
</h2>
<p><br></p>
<p>A PCA and UMAP representation of dataset before performing
integration can be obtained with <code>Coralysis</code>. Several
parameters can be provided to the functions in order to adjust the
analyses to the dataset (see <code>?Coralysis::RunPCA()</code> and
<code><a href="../reference/RunUMAP.html">?Coralysis::RunUMAP</a></code>).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Dimensional reduction - unintegrated</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RunPCA.html">RunPCA</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, assay.name <span class="op">=</span> <span class="st">"logcounts"</span>, dimred.name <span class="op">=</span> <span class="st">"unintPCA"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">30</span>, dimred.type <span class="op">=</span> <span class="st">"unintPCA"</span>, </span>
<span>               umap.method <span class="op">=</span> <span class="st">"uwot"</span>, dimred.name <span class="op">=</span> <span class="st">"unintUMAP"</span>, </span>
<span>               n_neighbors <span class="op">=</span> <span class="fl">15</span>, min_dist <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting </span></span>
<span><span class="va">original.cell.label</span> <span class="op">&lt;-</span> <span class="st">"cell_type"</span></span>
<span><span class="va">cell.label</span> <span class="op">&lt;-</span> <span class="st">"predicted_celltype_l2"</span></span>
<span><span class="va">vars2plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">batch.label</span>, <span class="va">original.cell.label</span>, <span class="va">cell.label</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vars2plot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">vars2plot</span></span>
<span><span class="va">unint.plts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">vars2plot</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/PlotDimRed.html">PlotDimRed</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, color.by <span class="op">=</span> <span class="va">x</span>, point.size <span class="op">=</span> <span class="fl">0.2</span>, legend.nrow <span class="op">=</span> <span class="fl">10</span>, point.stroke <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co"># plot each variable</span></span>
<span><span class="va">all.unint.plts</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">unint.plts</span>, ncol <span class="op">=</span> <span class="fl">3</span>, align <span class="op">=</span> <span class="st">"vh"</span><span class="op">)</span> <span class="co"># join plots together</span></span>
<span><span class="va">all.unint.plts</span></span></code></pre></div>
<p><img src="02_CellState_files/figure-html/unintegrated%20dimred-1.png" width="1008" style="display: block; margin: auto;"></p>
<p>It is clear the donor effect, particularly for some cell types, such
as CD14 monocytes and CD8 memory T cells.</p>
<p><br></p>
<p><br></p>
<hr>
<p><br></p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="multi-level-integration">Multi-level integration<a class="anchor" aria-label="anchor" href="#multi-level-integration"></a>
</h2>
<p><br></p>
<p>Multi-level integration can be performed with <code>Coralysis</code>
by running the function <code><a href="../reference/RunParallelDivisiveICP.html">RunParallelDivisiveICP()</a></code>. Only the
<code>batch.label</code> parameter is required. The
<code>batch.label</code> corresponds to a variable in
<code>colData</code>. In this case <code>Donor_full</code>. The
<code><a href="../reference/RunParallelDivisiveICP.html">RunParallelDivisiveICP()</a></code> function can be run in parallel by
providing the number of <code>threads</code> to reduce the run time (it
takes around 40 min. with 4 threads). Consult the full documentation of
this function with <code><a href="../reference/RunParallelDivisiveICP.html">?RunParallelDivisiveICP</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform multi-level integration</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RunParallelDivisiveICP.html">RunParallelDivisiveICP</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, batch.label <span class="op">=</span> <span class="st">"Donor_full"</span>, threads <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
  |                                                                            
  |                                                                      |   0%
  |                                                                            
  |=                                                                     |   2%
  |                                                                            
  |===                                                                   |   4%
  |                                                                            
  |====                                                                  |   6%
  |                                                                            
  |======                                                                |   8%
  |                                                                            
  |=======                                                               |  10%
  |                                                                            
  |=========                                                             |  12%
  |                                                                            
  |==========                                                            |  14%
  |                                                                            
  |===========                                                           |  16%
  |                                                                            
  |=============                                                         |  18%
  |                                                                            
  |==============                                                        |  20%
  |                                                                            
  |================                                                      |  22%
  |                                                                            
  |=================                                                     |  24%
  |                                                                            
  |===================                                                   |  27%
  |                                                                            
  |====================                                                  |  29%
  |                                                                            
  |=====================                                                 |  31%
  |                                                                            
  |=======================                                               |  33%
  |                                                                            
  |========================                                              |  35%
  |                                                                            
  |==========================                                            |  37%
  |                                                                            
  |===========================                                           |  39%
  |                                                                            
  |=============================                                         |  41%
  |                                                                            
  |==============================                                        |  43%
  |                                                                            
  |===============================                                       |  45%
  |                                                                            
  |=================================                                     |  47%
  |                                                                            
  |==================================                                    |  49%
  |                                                                            
  |====================================                                  |  51%
  |                                                                            
  |=====================================                                 |  53%
  |                                                                            
  |=======================================                               |  55%
  |                                                                            
  |========================================                              |  57%
  |                                                                            
  |=========================================                             |  59%
  |                                                                            
  |===========================================                           |  61%
  |                                                                            
  |============================================                          |  63%
  |                                                                            
  |==============================================                        |  65%
  |                                                                            
  |===============================================                       |  67%
  |                                                                            
  |=================================================                     |  69%
  |                                                                            
  |==================================================                    |  71%
  |                                                                            
  |===================================================                   |  73%
  |                                                                            
  |=====================================================                 |  76%
  |                                                                            
  |======================================================                |  78%
  |                                                                            
  |========================================================              |  80%
  |                                                                            
  |=========================================================             |  82%
  |                                                                            
  |===========================================================           |  84%
  |                                                                            
  |============================================================          |  86%
  |                                                                            
  |=============================================================         |  88%
  |                                                                            
  |===============================================================       |  90%
  |                                                                            
  |================================================================      |  92%
  |                                                                            
  |==================================================================    |  94%
  |                                                                            
  |===================================================================   |  96%
  |                                                                            
  |===================================================================== |  98%
  |                                                                            
  |======================================================================| 100%</code></pre>
<p><code>Coralysis</code> returns a list of cell cluster probabilities
saved at <code>metadata(sce)$coralysis$joint.probability</code> of
length equal to the number of icp runs, i.e., <code>L</code> (by default
<code>L=50</code>), times the number of icp rounds, i.e.,
log2(<code>k</code>) (by default <code>k=16</code>, thus 4 rounds of
divisive icp).</p>
<p>The cell cluster probability for a given icp run through its divisive
rounds can be plotted with the function <code><a href="../reference/PlotClusterTree.html">PlotClusterTree()</a></code>.
A <code>colData</code> variable can be provided to see its composition
per cluster across divisive rounds for the respective icp run. See
examples below for icp run number 42.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Plot cluster tree for icp run 13</span></span>
<span><span class="co"># Probability</span></span>
<span><span class="va">prob.cluster.tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PlotClusterTree.html">PlotClusterTree</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, icp.run <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># batch label distribution</span></span>
<span><span class="va">batch.cluster.tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PlotClusterTree.html">PlotClusterTree</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, icp.run <span class="op">=</span> <span class="fl">42</span>, color.by <span class="op">=</span> <span class="st">"Donor_full"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># original cell type label distribution</span></span>
<span><span class="va">orig.cell.cluster.tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PlotClusterTree.html">PlotClusterTree</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, icp.run <span class="op">=</span> <span class="fl">42</span>, color.by <span class="op">=</span> <span class="st">"cell_type"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Azimuth/predicted cell type label distribution</span></span>
<span><span class="va">cell.cluster.tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PlotClusterTree.html">PlotClusterTree</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, icp.run <span class="op">=</span> <span class="fl">42</span>, color.by <span class="op">=</span> <span class="st">"predicted_celltype_l2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Join all plots with 'cowplot'</span></span>
<span><span class="va">all.cluster.tree</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">prob.cluster.tree</span>, <span class="va">batch.cluster.tree</span>, </span>
<span>                                                          ncol <span class="op">=</span> <span class="fl">2</span>, rel_widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, align <span class="op">=</span> <span class="st">"v"</span><span class="op">)</span>, </span>
<span>                                       <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">orig.cell.cluster.tree</span>, <span class="va">cell.cluster.tree</span>, </span>
<span>                                                          ncol <span class="op">=</span> <span class="fl">2</span>, rel_widths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>, align <span class="op">=</span> <span class="st">"vh"</span><span class="op">)</span>,</span>
<span>                                       ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">all.cluster.tree</span></span></code></pre></div>
<p><img src="02_CellState_files/figure-html/multi-level%20probability-1.png" width="1344" style="display: block; margin: auto;"></p>
<p>Some cell types formed unique clusters, but quite few remained mixed.
Multi-level integration resolution might get better by running
<code><a href="../reference/RunParallelDivisiveICP.html">RunParallelDivisiveICP()</a></code> with 32 cluster, i.e.,
<code>k = 32</code>, instead 16.</p>
<p><br></p>
<p><br></p>
<hr>
<p><br></p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="dimred---after-integration">Dimred - after integration<a class="anchor" aria-label="anchor" href="#dimred---after-integration"></a>
</h2>
<p><br></p>
<p><code>Coralysis</code> returns a list of cell cluster probabilities
saved at <code>metadata(sce)$coralysis$joint.probability</code> of
length equal to the number of icp runs, i.e., <code>L</code> (by default
<code>L=50</code>), times the number of icp rounds, i.e.,
log2(<code>k</code>) (by default <code>k=16</code>, thus 4 rounds of
divisive icp). The cell cluster probability can be concatenated to
compute a PCA in order to obtain an integrated embedded. By default only
the cell cluster probability corresponding to the last icp round is
used. The <code>Coralysis</code> integrated embedding can be used
downstream for non-linear dimensional reduction, t-SNE or UMAP, and
clustering.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Dimensional reduction - unintegrated</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RunPCA.html">RunPCA</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, assay.name <span class="op">=</span> <span class="st">"joint.probability"</span>, dimred.name <span class="op">=</span> <span class="st">"intPCA"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Divisive ICP: selecting ICP tables multiple of 4</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># UMAP</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/RunUMAP.html">RunUMAP</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, dimred.type <span class="op">=</span> <span class="st">"intPCA"</span>, </span>
<span>               umap.method <span class="op">=</span> <span class="st">"uwot"</span>, dimred.name <span class="op">=</span> <span class="st">"intUMAP"</span>, </span>
<span>               dims <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">50</span>, n_neighbors <span class="op">=</span> <span class="fl">15</span>, min_dist <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting </span></span>
<span><span class="va">int.plts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">vars2plot</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/PlotDimRed.html">PlotDimRed</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, color.by <span class="op">=</span> <span class="va">x</span>, point.size <span class="op">=</span> <span class="fl">0.2</span>, legend.nrow <span class="op">=</span> <span class="fl">10</span>, point.stroke <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co"># plot each variable</span></span>
<span><span class="va">all.int.plts</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">int.plts</span>, ncol <span class="op">=</span> <span class="fl">3</span>, align <span class="op">=</span> <span class="st">"vh"</span><span class="op">)</span> <span class="co"># join plots together</span></span>
<span><span class="va">all.int.plts</span></span></code></pre></div>
<p><img src="02_CellState_files/figure-html/integrated%20dimred-1.png" width="1008" style="display: block; margin: auto;"></p>
<p><code>Coralysis</code> efficiently integrated the donor PBMC samples,
identified small populations (e.g., neutrophils, Treg, MAIT, dnT, NK
CD56bright), and differentiation trajectories (e.g., B naive to
memory).</p>
</div>
<div class="section level2">
<h2 id="graph-based-clustering">Graph-based clustering<a class="anchor" aria-label="anchor" href="#graph-based-clustering"></a>
</h2>
<p>Graph-based clustering can be obtained by running the
<code>scran</code> function <code>clusterCells()</code> using the
<code>Coralysis</code> integrated embedding. In alternative, the joint
cluster probabilities can be used for clustering. The advantages of
using the integrated embedding instead joint probabilities are:
computational efficiency; and, noise robustness. Using the joint
probabilities instead PCA embedding takes considerably more time.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Graph-based clustering with scran</span></span>
<span><span class="co">## Coralysis integrated PCA embedding </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1024</span><span class="op">)</span></span>
<span><span class="va">sce</span><span class="op">$</span><span class="va">emb_clusters</span> <span class="op">&lt;-</span> <span class="fu">scran</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scran/man/clusterCells.html" class="external-link">clusterCells</a></span><span class="op">(</span><span class="va">sce</span>, use.dimred <span class="op">=</span> <span class="st">"intPCA"</span>, </span>
<span>                                        BLUSPARAM <span class="op">=</span> <span class="fu">bluster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bluster/man/NNGraphParam-class.html" class="external-link">SNNGraphParam</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">15</span>, cluster.fun <span class="op">=</span> <span class="st">"louvain"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Coralysis joint cluster probabilities</span></span>
<span><span class="co"># retrieve ICP cell cluster probability tables for every icp run, but only for the last divisive round</span></span>
<span><span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/GetCellClusterProbability.html">GetCellClusterProbability</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, icp.round <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> </span>
<span><span class="co"># dim(probs) # 44721 cells x 800 clusters (16 clusters x 50 icp runs = 800 clusters) </span></span>
<span><span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">probs</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">probs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sce</span><span class="op">)</span></span>
<span><span class="va">prob.sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SingleCellExperiment/man/SingleCellExperiment.html" class="external-link">SingleCellExperiment</a></span><span class="op">(</span>assays <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"probability"</span> <span class="op">=</span> <span class="va">probs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1024</span><span class="op">)</span></span>
<span><span class="va">sce</span><span class="op">$</span><span class="va">prob_clusters</span> <span class="op">&lt;-</span> <span class="fu">scran</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scran/man/clusterCells.html" class="external-link">clusterCells</a></span><span class="op">(</span><span class="va">prob.sce</span>, </span>
<span>                                         assay.type <span class="op">=</span> <span class="st">"probability"</span>,</span>
<span>                                         BLUSPARAM <span class="op">=</span> <span class="fu">bluster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/bluster/man/NNGraphParam-class.html" class="external-link">SNNGraphParam</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">15</span>, cluster.fun <span class="op">=</span> <span class="st">"louvain"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plotting</span></span>
<span><span class="va">vars2plot2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cell.label</span>, <span class="st">"emb_clusters"</span>, <span class="st">"prob_clusters"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vars2plot2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">vars2plot2</span></span>
<span><span class="va">clts.plts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">vars2plot2</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/PlotDimRed.html">PlotDimRed</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, color.by <span class="op">=</span> <span class="va">x</span>, point.size <span class="op">=</span> <span class="fl">0.2</span>, legend.nrow <span class="op">=</span> <span class="fl">10</span>, point.stroke <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span> <span class="co"># plot each variable</span></span>
<span><span class="va">all.clts.plts</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">clts.plts</span>, ncol <span class="op">=</span> <span class="fl">3</span>, align <span class="op">=</span> <span class="st">"vh"</span><span class="op">)</span> <span class="co"># join plots together</span></span>
<span><span class="va">all.clts.plts</span></span></code></pre></div>
<p><img src="02_CellState_files/figure-html/graph-based%20clustering-1.png" width="1008" style="display: block; margin: auto;"></p>
<p><br></p>
<p><br></p>
<hr>
<p><br></p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="cell-state-identification">Cell state identification<a class="anchor" aria-label="anchor" href="#cell-state-identification"></a>
</h2>
<p><br></p>
<p>The cell cluster probability aggregated by mean or median across the
icp runs can be obtained with the function
<code><a href="../reference/SummariseCellClusterProbability.html">SummariseCellClusterProbability()</a></code> and plotted to infer
transient and steady cell states.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Summarise cell cluster probability</span></span>
<span><span class="va">sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SummariseCellClusterProbability.html">SummariseCellClusterProbability</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, icp.round <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="co"># save result in 'colData'</span></span>
<span><span class="co"># colData(sce) # check the colData</span></span>
<span></span>
<span><span class="co"># Plot cell cluster probabilities - mean</span></span>
<span><span class="co"># possible options: "mean_probs", "median_probs", "scaled_median_probs" </span></span>
<span><span class="fu"><a href="../reference/PlotExpression.html">PlotExpression</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, color.by <span class="op">=</span> <span class="st">"scaled_mean_probs"</span>, color.scale <span class="op">=</span> <span class="st">"viridis"</span>, </span>
<span>               point.size <span class="op">=</span> <span class="fl">0.2</span>, point.stroke <span class="op">=</span> <span class="fl">0.1</span>, legend.title <span class="op">=</span> <span class="st">"Mean prob.\n(min-max)"</span><span class="op">)</span> </span></code></pre></div>
<p><img src="02_CellState_files/figure-html/cell%20state%20identification-1.png" width="480" style="display: block; margin: auto;"></p>
<p>For instance, B cell states (naive, intermediate, memory) are not
well supported by <code>Coralysis</code> cell cluster probability,
probably because it would require to run <code>Coralysis</code> at
higher resolution, i.e., <code>k=32</code> instead
<code>k=16</code>.</p>
<p><br></p>
<p><br></p>
<hr>
<p><br></p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="label-gene-coefficients-by-majority-voting">Label gene coefficients by majority voting<a class="anchor" aria-label="anchor" href="#label-gene-coefficients-by-majority-voting"></a>
</h2>
<p><br></p>
<p>Gene coefficients can be obtained for a given cell label through
majority voting with the function <code><a href="../reference/MajorityVotingFeatures.html">MajorityVotingFeatures()</a></code>.
The majority voting is performed by searching for the most
representative cluster for a given cell label across all possible
clusters (i.e., across all icp runs and rounds). The most representative
cluster corresponds to the cluster with the highest majority voting
score. This corresponds to the geometric mean between the proportion of
cells from the given label intersected with a cluster and the proportion
of cells from that same cluster that intersected with the cells from the
given label. The higher the score the better. A cluster that scores 1
indicates that all its cells correspond to the assigned label, and vice
versa; i.e., all the cells with the assigned label belong to this
cluster. For example, <code><a href="../reference/MajorityVotingFeatures.html">MajorityVotingFeatures()</a></code> by providing
the <code>colData</code> variable <code>"emb_clusters"</code>(i.e.,
<code>label="emb_clusters"</code>).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get label gene coefficients by majority voting</span></span>
<span><span class="va">clts.gene.coeff</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MajorityVotingFeatures.html">MajorityVotingFeatures</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, label <span class="op">=</span> <span class="st">"emb_clusters"</span><span class="op">)</span></span></code></pre></div>
<p>The function <code><a href="../reference/MajorityVotingFeatures.html">MajorityVotingFeatures()</a></code> returns a list
with two elements:</p>
<ul>
<li><p><code>feature_coeff</code>: a list of data frames comprising the
gene coefficients and respective weights.</p></li>
<li><p><code>summary</code>: a data frame summarizing which ICP cluster
best represents each cell label, along with the respective majority
voting score.</p></li>
</ul>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Print cluster gene coefficients summary</span></span>
<span><span class="va">clts.gene.coeff</span><span class="op">$</span><span class="va">summary</span></span></code></pre></div>
<pre><code><span><span class="co">##    label icp_run icp_round cluster     score</span></span>
<span><span class="co">## 1      1      32         4       1 0.8854464</span></span>
<span><span class="co">## 2      2       8         4       2 0.8029275</span></span>
<span><span class="co">## 3      3      22         4       5 0.5766541</span></span>
<span><span class="co">## 4      4      33         4       5 0.9547252</span></span>
<span><span class="co">## 5      5      47         4       7 0.7899177</span></span>
<span><span class="co">## 6      6       2         4      11 0.7727299</span></span>
<span><span class="co">## 7      7      31         4       2 0.7066273</span></span>
<span><span class="co">## 8      8      22         4       8 0.8764744</span></span>
<span><span class="co">## 9      9      36         4       3 0.9384610</span></span>
<span><span class="co">## 10    10      47         4      15 0.6753852</span></span>
<span><span class="co">## 11    11      40         3       5 0.5651993</span></span>
<span><span class="co">## 12    12       9         4      14 0.8316545</span></span>
<span><span class="co">## 13    13      49         4      16 0.8342693</span></span>
<span><span class="co">## 14    14      34         3       5 0.7364123</span></span>
<span><span class="co">## 15    15      28         4       1 0.6918241</span></span>
<span><span class="co">## 16    16       3         4      12 0.8207624</span></span>
<span><span class="co">## 17    17      25         4      16 0.4316837</span></span>
<span><span class="co">## 18    18      40         4       6 0.8674741</span></span>
<span><span class="co">## 19    19      46         4       6 0.9495629</span></span>
<span><span class="co">## 20    20      40         4       1 0.8132710</span></span>
<span><span class="co">## 21    21      48         4      11 0.7210690</span></span>
<span><span class="co">## 22    22      33         4       4 0.6778038</span></span>
<span><span class="co">## 23    23      32         4       5 0.8918649</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Print top 30 positive gene coefficients for cluster 21 (corresponding to CD8 naive T cells based on Azimuth annotations)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">clts.gene.coeff</span><span class="op">$</span><span class="va">feature_coeff</span><span class="op">$</span><span class="va">`21`</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">clts.gene.coeff</span><span class="op">$</span><span class="va">feature_coeff</span><span class="op">$</span><span class="va">`21`</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span>, <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           feature coeff_clt11</span></span>
<span><span class="co">## 19           CD8B  1.22619799</span></span>
<span><span class="co">## 18           CD8A  0.90092405</span></span>
<span><span class="co">## 70  RP11-291B21.2  0.56716552</span></span>
<span><span class="co">## 77            SKI  0.56677043</span></span>
<span><span class="co">## 95            TTN  0.51546293</span></span>
<span><span class="co">## 65         PRRC2B  0.51026741</span></span>
<span><span class="co">## 59     PCED1B-AS1  0.50039030</span></span>
<span><span class="co">## 89         TBC1D4  0.49940311</span></span>
<span><span class="co">## 43            ITK  0.40797111</span></span>
<span><span class="co">## 1           ACAP1  0.32258468</span></span>
<span><span class="co">## 81          SOCS3  0.30357642</span></span>
<span><span class="co">## 63          PLCG1  0.25315596</span></span>
<span><span class="co">## 96            TXK  0.24066515</span></span>
<span><span class="co">## 25        FAM102A  0.21608469</span></span>
<span><span class="co">## 83         SPOCK2  0.20044225</span></span>
<span><span class="co">## 79          SLFN5  0.13378946</span></span>
<span><span class="co">## 68          RCAN3  0.11383799</span></span>
<span><span class="co">## 101        ZNF106  0.10929793</span></span>
<span><span class="co">## 94        TSC22D3  0.09985137</span></span>
<span><span class="co">## 26            FOS  0.08740513</span></span>
<span><span class="co">## 56           NKTR  0.08706334</span></span>
<span><span class="co">## 16           CD3D  0.07613402</span></span>
<span><span class="co">## 14           CCR7  0.07542613</span></span>
<span><span class="co">## 10          BIRC6  0.07336380</span></span>
<span><span class="co">## 38         IPCEF1  0.06746328</span></span>
<span><span class="co">## 76           RSF1  0.04338863</span></span>
<span><span class="co">## 40          ITGA6  0.04214525</span></span>
<span><span class="co">## 93          TRBC2  0.03751715</span></span>
<span><span class="co">## 45        LDLRAP1  0.03632500</span></span>
<span><span class="co">## 24            EVL  0.02270878</span></span></code></pre>
<p><br></p>
<p><br></p>
<hr>
<p><br></p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="cd14-monocytes-cluster-gene-coefficients---5-versus-8">CD14 monocytes: cluster gene coefficients - 5 versus 8<a class="anchor" aria-label="anchor" href="#cd14-monocytes-cluster-gene-coefficients---5-versus-8"></a>
</h2>
<p><br></p>
<p><code>Coralysis</code> identified two clusters of CD14 monocytes: 5
and 8 (considering the Louvain clustering obtained with the integrated
embedding). A few top positive gene coefficients in cluster 5 and 8 were
selected and plotted (gene expression was scaled).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Cluster gene coefficients: 5 versus 8</span></span>
<span><span class="va">clt5</span> <span class="op">&lt;-</span> <span class="va">clts.gene.coeff</span><span class="op">$</span><span class="va">feature_coeff</span><span class="op">$</span><span class="va">`5`</span></span>
<span><span class="va">clt5</span> <span class="op">&lt;-</span> <span class="va">clt5</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">clt5</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="va">clt8</span> <span class="op">&lt;-</span> <span class="va">clts.gene.coeff</span><span class="op">$</span><span class="va">feature_coeff</span><span class="op">$</span><span class="va">`8`</span> <span class="co"># copy data frame of gene coefficients for cluster 8 </span></span>
<span><span class="va">clt8</span> <span class="op">&lt;-</span> <span class="va">clt8</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">clt8</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,<span class="op">]</span></span>
<span></span>
<span><span class="co"># Merge cluster coefficients</span></span>
<span><span class="va">clt5vs8</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">clt5</span>, <span class="va">clt8</span>, all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">clt5vs8</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">clt5vs8</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">clt5vs8.parsed</span> <span class="op">&lt;-</span> <span class="va">clt5vs8</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="st">"coeff_variation"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">coeff_clt7</span> <span class="op">-</span> <span class="va">coeff_clt8</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">coeff_variation</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">coeff_clt7</span><span class="op">!=</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">coeff_clt8</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">coeff_clt7</span> <span class="op">*</span> <span class="va">coeff_clt8</span><span class="op">)</span><span class="op">&lt;</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">top5.clt5</span> <span class="op">&lt;-</span> <span class="va">clt5vs8.parsed</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">coeff_clt7</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">feature</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">top5.clt8</span> <span class="op">&lt;-</span> <span class="va">clt5vs8.parsed</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">coeff_clt8</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">feature</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Top 5 positive coefficients in each cluster</span></span>
<span><span class="va">top5.genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">top5.clt5</span>, <span class="va">top5.clt8</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">top5.genes</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">top5.genes</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">top5.gexp.mono.clts.plts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">top5.genes</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/PlotExpression.html">PlotExpression</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, color.by <span class="op">=</span> <span class="va">x</span>, scale.values <span class="op">=</span> <span class="cn">TRUE</span>, point.size <span class="op">=</span> <span class="fl">0.25</span>, point.stroke <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">all.top5.gexp.mono.clts.plts</span> <span class="op">&lt;-</span> <span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">top5.gexp.mono.clts.plts</span>, ncol <span class="op">=</span> <span class="fl">5</span>, align <span class="op">=</span> <span class="st">"vh"</span><span class="op">)</span></span>
<span><span class="va">all.top5.gexp.mono.clts.plts</span></span></code></pre></div>
<p><img src="02_CellState_files/figure-html/cluster%20gene%20coefficients:%205%20vs%208-1.png" width="1536" style="display: block; margin: auto;"></p>
<p>The expression level of CYP1B1 in cluster 8 is slightly higher in
COVID-19 infected donor cells than healthy donors, particularly, for
ventilated versus healhty donors.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotExpression.html" class="external-link">plotExpression</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span><span class="op">[</span>,<span class="va">sce</span><span class="op">$</span><span class="va">emb_clusters</span><span class="op">==</span><span class="st">"8"</span><span class="op">]</span>, features <span class="op">=</span> <span class="st">"CYP1B1"</span>, </span>
<span>                       color_by <span class="op">=</span> <span class="st">"Ventilated"</span>, x <span class="op">=</span> <span class="st">"Ventilated"</span><span class="op">)</span></span></code></pre></div>
<p><img src="02_CellState_files/figure-html/violin%20plot:%20CYP1B1-1.png" width="288" style="display: block; margin: auto;"></p>
<p>The previous plots suggest that clusters 5 and 8 are phenotypically
different. In addition, low expression of HLA-DR (HLA-DRA, HLA-DRB1)
genes has been associated with severe inflammatory conditions like
COVID-19 (see plots below) as well as high expression of S100A9. These
results suggest that cluster 8 corresponds to strongly activated or
possibly dysregulated monocytes, which are more common in severe
COVID-19 than in cluster 5. Indeed, almost half (48%) the cells in
cluster 8 are from COVID-19 infected donors that required ventilation,
whereas this percentage was close to 30% for cluster 5.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">genes2plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HLA-DRA"</span>, <span class="st">"HLA-DRB1"</span><span class="op">)</span></span>
<span><span class="va">gexp.hla.plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">genes2plot</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/PlotExpression.html">PlotExpression</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, color.by <span class="op">=</span> <span class="va">x</span>, scale.values <span class="op">=</span> <span class="cn">TRUE</span>, point.size <span class="op">=</span> <span class="fl">0.25</span>, point.stroke <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">gexp.hla.plots</span>, ncol <span class="op">=</span> <span class="fl">2</span>, align <span class="op">=</span> <span class="st">"vh"</span><span class="op">)</span></span></code></pre></div>
<p><img src="02_CellState_files/figure-html/plot%20HLA-DR%20genes-1.png" width="768" style="display: block; margin: auto;"></p>
<p><br></p>
<p><br></p>
<hr>
<p><br></p>
<p><br></p>
</div>
<div class="section level2">
<h2 id="cell-state-association-with-covid-19">Cell state association with COVID-19<a class="anchor" aria-label="anchor" href="#cell-state-association-with-covid-19"></a>
</h2>
<p><br></p>
<p>The cell cluster probability can be used to search for altered cell
states, e.g., associated with COVID-19. The distribution of cell cluster
probability per cluster (integrated embedding) per
<code>ventilated</code> group is shown below after running the function
<code><a href="../reference/CellClusterProbabilityDistribution.html">CellClusterProbabilityDistribution()</a></code>. Cluster 18, roughly
corresponding to CD16 monocytes, shows a difference between healthy and
COVID associated cells (non-ventilated and ventilated donor cells).</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Disease associated cell state </span></span>
<span><span class="co"># Search for diseased affected cell states</span></span>
<span><span class="va">prob.dist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CellClusterProbabilityDistribution.html">CellClusterProbabilityDistribution</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, </span>
<span>                                                label <span class="op">=</span> <span class="st">"emb_clusters"</span>, </span>
<span>                                                group <span class="op">=</span> <span class="st">"Ventilated"</span>, </span>
<span>                                                probability <span class="op">=</span> <span class="st">"scaled_mean_probs"</span><span class="op">)</span></span>
<span><span class="va">prob.dist</span></span></code></pre></div>
<p><img src="02_CellState_files/figure-html/disease-associated%20cell%20states-1.png" width="1920" style="display: block; margin: auto;"></p>
<p>Cell cluster probability bins per cluster <code>label</code> can be
obtained by running <code><a href="../reference/BinCellClusterProbability.html">BinCellClusterProbability()</a></code>, which
returns a <code>SingleCellExperiment</code> object with
<code>logcounts</code> average per <code>label</code> per cell
probability bin. The number of probability bins can be provided to the
parameter <code>bins</code>. The cell frequency per cell bin per group
of interest can be obtained with the function
<code><a href="../reference/TabulateCellBinsByGroup.html">TabulateCellBinsByGroup()</a></code>. The heatmap below shows the cell
frequency across ventilated groups per bins for cluster 18
(corresponding to CD16 monocytes). The cell frequency represented below
corresponds to the cell proportions per group (healthy, non-ventilated
and ventilated) scaled by bins, i.e., columns. Cell states with higher
probabilities tend to be more â€œhealthierâ€ than states with lower
probabilities.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># cell states SCE object </span></span>
<span><span class="va">cellstate.sce</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/BinCellClusterProbability.html">BinCellClusterProbability</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">sce</span>, label <span class="op">=</span> <span class="st">"emb_clusters"</span>, icp.round <span class="op">=</span> <span class="fl">4</span>, bins <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> </span>
<span></span>
<span><span class="co"># Tabulate cell bins by group </span></span>
<span><span class="va">cellbins.tables</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/TabulateCellBinsByGroup.html">TabulateCellBinsByGroup</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">cellstate.sce</span>, group <span class="op">=</span> <span class="st">"Ventilated"</span>, relative <span class="op">=</span> <span class="cn">TRUE</span>, margin <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Heatmap of cell bins distribution by group for cluster 20 - CD16 Monocytes</span></span>
<span><span class="va">cluster</span> <span class="op">&lt;-</span> <span class="st">"18"</span></span>
<span><span class="va">col.fun</span> <span class="op">&lt;-</span> <span class="fu">circlize</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/circlize/man/colorRamp2.html" class="external-link">colorRamp2</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.5</span>, <span class="fl">0</span>, <span class="fl">1.5</span><span class="op">)</span>, <span class="fu">viridis</span><span class="fu">::</span><span class="fu"><a href="https://sjmgarnier.github.io/viridisLite/reference/viridis.html" class="external-link">inferno</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">heat.plot</span> <span class="op">&lt;-</span> <span class="fu">ComplexHeatmap</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span>matrix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">cellbins.tables</span><span class="op">[[</span><span class="va">cluster</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                                     name <span class="op">=</span> <span class="st">"Col. Z-score"</span>, </span>
<span>                                     cluster_rows <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                                     cluster_columns <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>                                     row_names_side <span class="op">=</span> <span class="st">"left"</span>, </span>
<span>                                     col <span class="op">=</span> <span class="va">col.fun</span>, </span>
<span>                                     column_title <span class="op">=</span> <span class="st">"Distribution of cells per cell cluster probability bin"</span>, </span>
<span>                                     heatmap_legend_param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>legend_direction <span class="op">=</span> <span class="st">"horizontal"</span>, title_position <span class="op">=</span> <span class="st">"topcenter"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">ComplexHeatmap</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html" class="external-link">draw</a></span><span class="op">(</span><span class="va">heat.plot</span>, heatmap_legend_side <span class="op">=</span> <span class="st">"bottom"</span>, annotation_legend_side <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="02_CellState_files/figure-html/tabulate%20cell%20bins%20by%20group-1.png" width="384" style="display: block; margin: auto;"></p>
<p>The correlation between cell cluster probability bins from cluster 18
and averaged gene expression can be obtained with the function
<code><a href="../reference/CellBinsFeatureCorrelation.html">CellBinsFeatureCorrelation()</a></code>. Among the several positively
and negatively correlated genes, the expression of C1QB seems to be
enriched in diseased cells, with a negative Pearson coefficient close to
0.8. This gene was selected as an example due to its expression being
relatively limited to cluster 18.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pearson correlated features with cluster 20</span></span>
<span><span class="va">cor.features.clt18</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CellBinsFeatureCorrelation.html">CellBinsFeatureCorrelation</a></span><span class="op">(</span>object <span class="op">=</span> <span class="va">cellstate.sce</span>, labels <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span></span>
<span><span class="va">cor.features.clt18</span> <span class="op">&lt;-</span> <span class="va">cor.features.clt18</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">`18`</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">`18`</span><span class="op">)</span> <span class="co"># C1QB</span></span>
<span><span class="va">exp.C1QB.umap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/PlotExpression.html">PlotExpression</a></span><span class="op">(</span><span class="va">sce</span>, color.by <span class="op">=</span> <span class="st">"C1QB"</span>, scale.values <span class="op">=</span> <span class="cn">TRUE</span>, point.size <span class="op">=</span> <span class="fl">0.5</span>, point.stroke <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">exp.C1QB.violin</span> <span class="op">&lt;-</span> <span class="fu">scater</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/scater/man/plotExpression.html" class="external-link">plotExpression</a></span><span class="op">(</span><span class="va">sce</span><span class="op">[</span>,<span class="va">sce</span><span class="op">$</span><span class="va">emb_clusters</span> <span class="op">==</span> <span class="va">cluster</span><span class="op">]</span>, features <span class="op">=</span> <span class="st">"C1QB"</span>,</span>
<span>                                          x <span class="op">=</span> <span class="st">"Ventilated"</span>, color_by <span class="op">=</span> <span class="st">"Ventilated"</span><span class="op">)</span></span>
<span><span class="va">exp.C1QB.umap</span></span></code></pre></div>
<p><img src="02_CellState_files/figure-html/differential%20expression%20programs-1.png" width="384" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exp.C1QB.violin</span></span></code></pre></div>
<p><img src="02_CellState_files/figure-html/print%20violin-1.png" width="700" style="display: block; margin: auto;"></p>
<p><br></p>
<p><br></p>
<hr>
<p><br></p>
<p><br></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># R session</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## R version 4.2.1 (2022-06-23)</span></span>
<span><span class="co">## Platform: x86_64-pc-linux-gnu (64-bit)</span></span>
<span><span class="co">## Running under: Ubuntu 20.04.5 LTS</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3</span></span>
<span><span class="co">## LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/liblapack.so.3</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              </span></span>
<span><span class="co">##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    </span></span>
<span><span class="co">##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   </span></span>
<span><span class="co">##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 </span></span>
<span><span class="co">##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            </span></span>
<span><span class="co">## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats4    stats     graphics  grDevices utils     datasets  methods  </span></span>
<span><span class="co">## [8] base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## other attached packages:</span></span>
<span><span class="co">##  [1] Coralysis_1.0.0             dplyr_1.1.1                </span></span>
<span><span class="co">##  [3] scater_1.26.1               ggplot2_3.5.1              </span></span>
<span><span class="co">##  [5] scuttle_1.8.4               SingleCellExperiment_1.20.1</span></span>
<span><span class="co">##  [7] SummarizedExperiment_1.28.0 Biobase_2.58.0             </span></span>
<span><span class="co">##  [9] GenomicRanges_1.50.2        GenomeInfoDb_1.34.9        </span></span>
<span><span class="co">## [11] IRanges_2.32.0              S4Vectors_0.36.2           </span></span>
<span><span class="co">## [13] BiocGenerics_0.44.0         MatrixGenerics_1.10.0      </span></span>
<span><span class="co">## [15] matrixStats_1.1.0          </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##   [1] snow_0.4-4                circlize_0.4.15          </span></span>
<span><span class="co">##   [3] systemfonts_1.0.4         plyr_1.8.8               </span></span>
<span><span class="co">##   [5] igraph_1.4.1              BiocParallel_1.32.6      </span></span>
<span><span class="co">##   [7] digest_0.6.31             foreach_1.5.2            </span></span>
<span><span class="co">##   [9] htmltools_0.5.4           viridis_0.6.2            </span></span>
<span><span class="co">##  [11] fansi_1.0.4               magrittr_2.0.3           </span></span>
<span><span class="co">##  [13] memoise_2.0.1             ScaledMatrix_1.6.0       </span></span>
<span><span class="co">##  [15] cluster_2.1.3             doParallel_1.0.17        </span></span>
<span><span class="co">##  [17] limma_3.54.2              ComplexHeatmap_2.14.0    </span></span>
<span><span class="co">##  [19] pkgdown_2.0.6             colorspace_2.1-0         </span></span>
<span><span class="co">##  [21] ggrepel_0.9.3             textshaping_0.3.6        </span></span>
<span><span class="co">##  [23] xfun_0.37                 crayon_1.5.2             </span></span>
<span><span class="co">##  [25] RCurl_1.98-1.10           jsonlite_1.8.4           </span></span>
<span><span class="co">##  [27] scatterpie_0.2.3          iterators_1.0.14         </span></span>
<span><span class="co">##  [29] glue_1.6.2                polyclip_1.10-4          </span></span>
<span><span class="co">##  [31] gtable_0.3.3              zlibbioc_1.44.0          </span></span>
<span><span class="co">##  [33] XVector_0.38.0            GetoptLong_1.0.5         </span></span>
<span><span class="co">##  [35] DelayedArray_0.24.0       BiocSingular_1.14.0      </span></span>
<span><span class="co">##  [37] shape_1.4.6               SparseM_1.81             </span></span>
<span><span class="co">##  [39] scales_1.3.0              pheatmap_1.0.12          </span></span>
<span><span class="co">##  [41] edgeR_3.40.2              rngtools_1.5.2           </span></span>
<span><span class="co">##  [43] Rcpp_1.0.10               viridisLite_0.4.1        </span></span>
<span><span class="co">##  [45] aricode_1.0.2             clue_0.3-64              </span></span>
<span><span class="co">##  [47] dqrng_0.3.0               rsvd_1.0.5               </span></span>
<span><span class="co">##  [49] metapod_1.6.0             RColorBrewer_1.1-3       </span></span>
<span><span class="co">##  [51] modeltools_0.2-23         pkgconfig_2.0.3          </span></span>
<span><span class="co">##  [53] farver_2.1.1              sass_0.4.5               </span></span>
<span><span class="co">##  [55] uwot_0.1.14               locfit_1.5-9.7           </span></span>
<span><span class="co">##  [57] utf8_1.2.3                tidyselect_1.2.0         </span></span>
<span><span class="co">##  [59] labeling_0.4.2            rlang_1.1.0              </span></span>
<span><span class="co">##  [61] reshape2_1.4.4            munsell_0.5.0            </span></span>
<span><span class="co">##  [63] tools_4.2.1               cachem_1.0.7             </span></span>
<span><span class="co">##  [65] cli_3.6.1                 generics_0.1.3           </span></span>
<span><span class="co">##  [67] evaluate_0.20             stringr_1.5.0            </span></span>
<span><span class="co">##  [69] fastmap_1.1.1             yaml_2.3.7               </span></span>
<span><span class="co">##  [71] ragg_1.2.4                knitr_1.42               </span></span>
<span><span class="co">##  [73] fs_1.6.1                  purrr_1.0.1              </span></span>
<span><span class="co">##  [75] RANN_2.6.1                doRNG_1.8.6              </span></span>
<span><span class="co">##  [77] sparseMatrixStats_1.10.0  scran_1.26.2             </span></span>
<span><span class="co">##  [79] flexclust_1.4-1           compiler_4.2.1           </span></span>
<span><span class="co">##  [81] rstudioapi_0.14           beeswarm_0.4.0           </span></span>
<span><span class="co">##  [83] png_0.1-8                 tibble_3.2.1             </span></span>
<span><span class="co">##  [85] statmod_1.5.0             tweenr_2.0.3             </span></span>
<span><span class="co">##  [87] bslib_0.4.2               stringi_1.7.12           </span></span>
<span><span class="co">##  [89] highr_0.10                desc_1.4.2               </span></span>
<span><span class="co">##  [91] RSpectra_0.16-1           lattice_0.20-45          </span></span>
<span><span class="co">##  [93] bluster_1.8.0             Matrix_1.6-5             </span></span>
<span><span class="co">##  [95] vctrs_0.6.1               pillar_1.9.0             </span></span>
<span><span class="co">##  [97] lifecycle_1.0.3           jquerylib_0.1.4          </span></span>
<span><span class="co">##  [99] LiblineaR_2.10-22         GlobalOptions_0.1.2      </span></span>
<span><span class="co">## [101] RcppAnnoy_0.0.20          BiocNeighbors_1.16.0     </span></span>
<span><span class="co">## [103] cowplot_1.1.1             bitops_1.0-7             </span></span>
<span><span class="co">## [105] irlba_2.3.5.1             R6_2.5.1                 </span></span>
<span><span class="co">## [107] gridExtra_2.3             vipor_0.4.5              </span></span>
<span><span class="co">## [109] codetools_0.2-18          MASS_7.3-57              </span></span>
<span><span class="co">## [111] rprojroot_2.0.3           rjson_0.2.21             </span></span>
<span><span class="co">## [113] withr_2.5.0               GenomeInfoDbData_1.2.9   </span></span>
<span><span class="co">## [115] parallel_4.2.1            doSNOW_1.0.20            </span></span>
<span><span class="co">## [117] grid_4.2.1                ggfun_0.1.3              </span></span>
<span><span class="co">## [119] beachmat_2.14.0           tidyr_1.3.0              </span></span>
<span><span class="co">## [121] class_7.3-20              rmarkdown_2.20           </span></span>
<span><span class="co">## [123] DelayedMatrixStats_1.20.0 Cairo_1.6-0              </span></span>
<span><span class="co">## [125] ggforce_0.4.1             ggbeeswarm_0.7.1</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by AntÃ³nio Sousa, Johannes Smolander, Sini Junttila, Laura L Elo.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
